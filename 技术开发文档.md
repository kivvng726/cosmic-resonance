# 寰宇回响 - 技术开发文档

## 📋 目录

- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [核心模块说明](#核心模块说明)
- [开发环境搭建](#开发环境搭建)
- [功能实现详解](#功能实现详解)
- [API 接口文档](#api-接口文档)
- [部署指南](#部署指南)
- [常见问题](#常见问题)
- [开发规范](#开发规范)

---

## 项目概述

**寰宇回响**（Cosmic Resonance）是一个基于多模态交互的沉浸式星象互动占卜装置。项目融合了3D图形渲染、手势识别、语音交互等前沿技术，为用户提供独特的占卜体验。

### 核心特性

- 🌌 **3D星空操控**：基于Three.js的实时3D星空渲染，支持手势和鼠标交互
- 👋 **手势识别**：基于MediaPipe的手势控制，支持左右移动和缩放
- 🎤 **语音交互**：Web Speech API实现语音输入和文本转语音播报
- 🔮 **智能占卜**：融合中西方星象智慧的占卜算法
- 🎨 **精美UI**：现代化的玻璃态设计，流畅的动画效果

---

## 技术栈

### 前端框架
- **HTML5**：语义化标签，结构清晰
- **CSS3**：现代CSS特性（Grid、Flexbox、动画、渐变）
- **JavaScript ES6+**：模块化开发，异步处理

### 核心库

| 库名 | 版本 | 用途 |
|------|------|------|
| Three.js | r128 | 3D图形渲染引擎 |
| GSAP | 3.12.2 | 动画库 |
| MediaPipe Hands | Latest | 手势识别 |

### Web API

- **Web Speech API**：语音识别和合成
- **MediaDevices API**：摄像头访问
- **Fullscreen API**：全屏模式
- **WebGL**：硬件加速3D渲染

---

## 项目结构

```
cosmic-resonance/
├── index.html              # 主HTML文件
├── css/
│   └── style.css           # 全局样式文件
├── js/
│   ├── app.js              # 主应用控制器
│   ├── starfield.js        # 3D星空场景管理
│   ├── gesture.js          # 手势识别控制
│   ├── voice.js            # 语音功能模块
│   └── divination.js       # 占卜逻辑处理
├── sounds/                 # 音效文件目录（可选）
├── assets/                 # 静态资源目录
└── README.md               # 项目说明文档
```

---

## 核心模块说明

### 1. app.js - 主应用控制器

**职责**：应用生命周期管理、页面导航、全局事件处理

**主要类**：`CosmicResonanceApp`

**核心方法**：
- `init()`：初始化应用
- `navigateToSection(sectionName)`：页面导航
- `handleKeyboardShortcuts(event)`：键盘快捷键处理
- `toggleSound()`：音效开关
- `toggleFullscreen()`：全屏切换

**关键特性**：
- 防止在输入框聚焦时触发快捷键
- 页面切换动画
- 音效管理

### 2. starfield.js - 3D星空场景

**职责**：Three.js场景管理、星空渲染、星座交互

**主要类**：`StarField3D`

**核心方法**：
- `init()`：初始化Three.js场景
- `createStarField()`：创建星空粒子系统
- `createConstellations()`：创建星座
- `animate()`：动画循环
- `resetView()`：重置视角

**技术要点**：
- 使用 `PointsMaterial` 和圆形纹理创建星星
- `BufferGeometry` 优化大量粒子渲染
- 射线检测实现星座点击交互
- GSAP实现平滑动画过渡

**性能优化**：
- 限制像素比（`devicePixelRatio` 最大2）
- 使用 `requestAnimationFrame` 优化渲染
- 合理控制星星数量（2000颗）

### 3. gesture.js - 手势识别

**职责**：摄像头访问、MediaPipe手势识别、手势到3D控制的映射

**主要类**：`GestureController`

**核心方法**：
- `startCamera()`：启动摄像头
- `createUI()`：创建摄像头UI
- `detectGestures(landmarks)`：手势检测和映射
- `calculateDistance(point1, point2)`：计算两点距离
- `stop()`：停止摄像头和清理资源

**手势映射**：
- **左右移动**：手腕X坐标变化 → 场景X轴平移
- **缩放**：拇指和食指距离变化 → 相机Z轴移动

**技术要点**：
- MediaPipe Hands从CDN加载
- 视频镜像处理（`scaleX(-1)`）
- 平滑处理避免抖动
- 错误处理和权限管理

### 4. voice.js - 语音功能

**职责**：语音识别、文本转语音、语音UI反馈

**主要类**：
- `VoiceInputSimulator`：语音输入
- `TextToSpeechSimulator`：语音播报

**核心方法**：
- `startRecognition()`：开始语音识别
- `speak(text, options)`：文本转语音
- `stop()`：停止语音播报
- `simulateVoiceInput()`：模拟语音输入（开发用）

**技术要点**：
- Web Speech API跨浏览器兼容
- 中文语音识别和合成
- 错误处理（interrupted错误静默处理）
- 语音可视化动画

### 5. divination.js - 占卜逻辑

**职责**：占卜流程控制、结果生成、结果展示

**主要类**：`DivinationController`

**核心方法**：
- `startDivination()`：开始占卜流程
- `processSteps()`：处理占卜步骤
- `generateResult()`：生成占卜结果
- `personalizeReading()`：个性化解读
- `playAudioReading()`：语音播报结果

**占卜算法**：
- 基于出生日期计算星座
- 根据问题关键词匹配主题
- 生成个性化解读文本
- 生成七言签文

---

## 开发环境搭建

### 1. 环境要求

- **Node.js**：v14+ （可选，用于本地服务器）
- **现代浏览器**：Chrome 90+, Firefox 88+, Safari 14+
- **Git**：版本控制

### 2. 克隆项目

```bash
git clone https://github.com/jojodd77/cosmic-resonance.git
cd cosmic-resonance
```

### 3. 启动本地服务器

**方法一：使用Python（推荐）**

```bash
# Python 3
python3 -m http.server 8000

# Python 2
python -m SimpleHTTPServer 8000
```

**方法二：使用Node.js**

```bash
# 安装http-server
npm install -g http-server

# 启动服务器
http-server -p 8000
```

**方法三：使用提供的脚本**

```bash
# macOS/Linux
chmod +x 快速启动本地服务器.sh
./快速启动本地服务器.sh
```

### 4. 访问应用

打开浏览器访问：`http://localhost:8000`

---

## 功能实现详解

### 3D星空渲染

#### 初始化场景

```javascript
// 创建场景、相机、渲染器
this.scene = new THREE.Scene();
this.camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
this.renderer = new THREE.WebGLRenderer({ 
    canvas: this.canvas, 
    alpha: false,
    antialias: true 
});
```

#### 创建星空粒子

```javascript
// 使用BufferGeometry优化性能
const starGeometry = new THREE.BufferGeometry();
const positions = new Float32Array(starCount * 3);

// 创建圆形纹理
const createStarTexture = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
    gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
    // ...
};

const starMaterial = new THREE.PointsMaterial({
    color: 0xffffff,
    map: createStarTexture(), // 使用圆形纹理
    size: 2,
    transparent: true
});
```

### 手势识别实现

#### MediaPipe初始化

```javascript
const hands = new Hands({
    locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }
});

hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});
```

#### 手势映射

```javascript
// 左右移动：手腕X坐标变化
const deltaX = -(wrist.x - this.lastHandPosition.x);
this.starField3D.scene.position.x += smoothedDeltaX * 40;

// 缩放：拇指和食指距离
const pinchDistance = this.calculateDistance(thumbTip, indexTip);
const distanceChange = pinchDistance - this.lastPinchDistance;
const zoomFactor = 1 - smoothedChange * 5.0;
this.starField3D.camera.position.z *= zoomFactor;
```

### 语音功能实现

#### 语音识别

```javascript
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'zh-CN';
recognition.continuous = false;
recognition.interimResults = false;

recognition.onresult = (event) => {
    const result = event.results[0][0].transcript;
    // 处理识别结果
};
```

#### 文本转语音

```javascript
const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = 'zh-CN';
utterance.rate = 0.8;
utterance.pitch = 1.1;
utterance.volume = 0.9;

utterance.onend = () => {
    // 更新UI状态
};

speechSynthesis.speak(utterance);
```

---

## API 接口文档

### 页面导航

```javascript
// 导航到指定页面
app.navigateToSection('starfield'); // 'welcome' | 'starfield' | 'input' | 'process' | 'result'
```

### 手势控制

```javascript
// 启用手势控制
gestureController.start();

// 停止手势控制
gestureController.stop();
```

### 语音功能

```javascript
// 开始语音识别
voiceInputSimulator.startRecognition();

// 文本转语音
textToSpeechSimulator.speak('文本内容', {
    rate: 0.8,
    pitch: 1.1,
    volume: 0.9
});

// 停止语音播报
textToSpeechSimulator.stop();
```

### 3D星空控制

```javascript
// 重置视角
starField3D.resetView();

// 激活占卜动画
starField3D.activateDivination();
```

---

## 部署指南

### GitHub Pages部署

1. **启用GitHub Pages**
   - 进入仓库 Settings → Pages
   - Source选择 `main` 分支
   - 选择 `/ (root)` 文件夹
   - 点击 Save

2. **访问网站**
   - 地址：`https://jojodd77.github.io/cosmic-resonance`
   - 部署通常需要1-2分钟

### Vercel部署

1. **安装Vercel CLI**
   ```bash
   npm i -g vercel
   ```

2. **部署**
   ```bash
   vercel
   ```

3. **配置**
   - Framework Preset: Other
   - Build Command: 留空
   - Output Directory: ./

详细步骤参考 `Vercel部署指南.md`

---

## 常见问题

### 1. 摄像头无法访问

**问题**：点击"启用手势控制"没有反应

**解决方案**：
- 检查浏览器权限设置
- 确保使用HTTPS或localhost
- 检查摄像头是否被其他应用占用

### 2. 手势识别不准确

**问题**：手势控制方向相反或响应不灵敏

**解决方案**：
- 调整 `gesture.js` 中的灵敏度参数
- 确保光线充足
- 手部距离摄像头30-50cm

### 3. 语音识别失败

**问题**：语音输入无法识别

**解决方案**：
- 检查浏览器是否支持Web Speech API
- 确保麦克风权限已授予
- 使用Chrome或Edge浏览器（支持最好）

### 4. 3D星空不显示

**问题**：页面空白或只有背景

**解决方案**：
- 检查浏览器控制台错误
- 确认Three.js CDN加载成功
- 检查Canvas元素是否正确创建

### 5. GitHub Pages 404错误

**问题**：部署后显示404

**解决方案**：
- 确认仓库为Public
- 检查Pages设置中的Source配置
- 等待几分钟让部署完成

---

## 开发规范

### 代码风格

1. **命名规范**
   - 类名：PascalCase（如 `CosmicResonanceApp`）
   - 变量/函数：camelCase（如 `startCamera`）
   - 常量：UPPER_SNAKE_CASE（如 `MAX_STARS`）

2. **注释规范**
   ```javascript
   /**
    * 函数功能描述
    * @param {type} paramName - 参数说明
    * @returns {type} 返回值说明
    */
   function example(paramName) {
       // 实现代码
   }
   ```

3. **文件组织**
   - 每个文件一个主要类
   - 相关功能放在同一文件
   - 避免全局变量污染

### Git提交规范

```
<type>: <subject>

<body>

<footer>
```

**Type类型**：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关

**示例**：
```
feat: 添加手势控制功能

- 集成MediaPipe Hands
- 实现左右移动和缩放手势
- 添加摄像头UI和错误处理
```

### 性能优化建议

1. **3D渲染**
   - 限制星星数量（2000-3000）
   - 使用BufferGeometry
   - 合理设置像素比

2. **手势识别**
   - 使用平滑处理避免抖动
   - 限制检测频率
   - 及时清理资源

3. **动画**
   - 使用CSS动画替代JS动画（可能时）
   - 使用`will-change`提示浏览器
   - 避免强制重排

---

## 浏览器兼容性

| 浏览器 | 版本要求 | 支持情况 |
|--------|---------|---------|
| Chrome | 90+ | ✅ 完全支持 |
| Edge | 90+ | ✅ 完全支持 |
| Firefox | 88+ | ⚠️ 部分功能（手势识别） |
| Safari | 14+ | ⚠️ 部分功能（语音识别） |

**注意事项**：
- MediaPipe Hands在Firefox中可能不稳定
- Safari的语音识别支持有限
- 建议主要使用Chrome/Edge浏览器

---

## 未来规划

### 短期计划
- [ ] 添加更多星座
- [ ] 优化手势识别准确度
- [ ] 添加音效文件
- [ ] 移动端适配

### 长期计划
- [ ] AI占卜算法优化
- [ ] 多语言支持
- [ ] 用户数据保存
- [ ] 社交分享功能

---

## 贡献指南

欢迎提交Issue和Pull Request！

1. Fork本项目
2. 创建特性分支（`git checkout -b feature/AmazingFeature`）
3. 提交更改（`git commit -m 'Add some AmazingFeature'`）
4. 推送到分支（`git push origin feature/AmazingFeature`）
5. 开启Pull Request

---

## 许可证

本项目采用 MIT 许可证。

---

## 联系方式

- **项目地址**：https://github.com/jojodd77/cosmic-resonance
- **问题反馈**：https://github.com/jojodd77/cosmic-resonance/issues

---

**最后更新**：2025年1月


